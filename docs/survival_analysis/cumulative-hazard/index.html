<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="累積ハザード関数の重要性 カプランマイヤー法は生存関数の推定を行う方法であった。
ここで、生存関数 \(S(t)\) と累積ハザード関数 \(H(t)\) の関係をもう一度思い出してみよう。
\[ \begin{align} H(t) &amp;= -\log{S(t)} \\
S(t) &amp;= \exp{(-S(t))} \ \end{align} \]
すなわち、 \(S(t)\) と \(H(t)\) は相互に変換可能である。
また、これに加えて、累積ハザード関数 \(H(t)\) を微分すれば、ハザード関数 \(h(t)\) を得ることができる。
\[ h(t) = \frac{\mathrm{d}}{\mathrm{d}t}H(t) \]
ハザード関数 \(h(t)\) は時刻がちょうど \(t\) のときに寿命を迎える確率に結びついている。
\[ h(t) = \lim_{\delta t \to 0}\frac{\mathrm{P(t \le T \le t &#43; \delta t|T &gt; t)}}{\delta t} \]
しかしながら、ハザード関数をデータから直接推定することは難しい。
累積ハザード関数を推定すれば、そこから生存関数やハザード関数を得ることができる。従って、生存時間解析において、累積ハザード関数を推定することは重要なステップとなる。
累積ハザード関数をデータから推定するためのノンパラメトリックな手法が、 Nelson-Aalen 法 である。
Nelson-Aalen 法 以下、Nelson-Aalen 法による累積ハザード関数の推定法について説明する。説明にはカプランマイヤー法のときと同じく カリフォルニア大学サンディエゴ校の例示用データセット を用いる。">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="累積ハザード関数" />
<meta property="og:description" content="累積ハザード関数の重要性 カプランマイヤー法は生存関数の推定を行う方法であった。
ここで、生存関数 \(S(t)\) と累積ハザード関数 \(H(t)\) の関係をもう一度思い出してみよう。
\[ \begin{align} H(t) &amp;= -\log{S(t)} \\
S(t) &amp;= \exp{(-S(t))} \ \end{align} \]
すなわち、 \(S(t)\) と \(H(t)\) は相互に変換可能である。
また、これに加えて、累積ハザード関数 \(H(t)\) を微分すれば、ハザード関数 \(h(t)\) を得ることができる。
\[ h(t) = \frac{\mathrm{d}}{\mathrm{d}t}H(t) \]
ハザード関数 \(h(t)\) は時刻がちょうど \(t\) のときに寿命を迎える確率に結びついている。
\[ h(t) = \lim_{\delta t \to 0}\frac{\mathrm{P(t \le T \le t &#43; \delta t|T &gt; t)}}{\delta t} \]
しかしながら、ハザード関数をデータから直接推定することは難しい。
累積ハザード関数を推定すれば、そこから生存関数やハザード関数を得ることができる。従って、生存時間解析において、累積ハザード関数を推定することは重要なステップとなる。
累積ハザード関数をデータから推定するためのノンパラメトリックな手法が、 Nelson-Aalen 法 である。
Nelson-Aalen 法 以下、Nelson-Aalen 法による累積ハザード関数の推定法について説明する。説明にはカプランマイヤー法のときと同じく カリフォルニア大学サンディエゴ校の例示用データセット を用いる。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hanakno863.github.io/learn-docs/docs/survival_analysis/cumulative-hazard/" />
<meta property="article:modified_time" content="2020-06-08T10:50:08+09:00" />
<title>累積ハザード関数 | Learn Docs</title>
<link rel="manifest" href="/learn-docs/manifest.json">
<link rel="icon" href="/learn-docs/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/learn-docs/book.min.e161f1fe2b283b6a43c29a52fde96e2387fade573e78efa6701d44c8499da76b.css" integrity="sha256-4WHx/isoO2pDwppS/eluI4f63lc&#43;eO&#43;mcB1EyEmdp2s=">
<script defer src="/learn-docs/en.search.min.a6da5a3b06cfb978b80d4265ab6dc7617786ddf6a8d00c1e741a3758614b5128.js" integrity="sha256-ptpaOwbPuXi4DUJlq23HYXeG3fao0AwedBo3WGFLUSg="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"],
    }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
      TeX: {
          Macros: { bm: ["\\boldsymbol{#1}", 1] }
      }
  });
</script>

<link rel="stylesheet" href="http://hanakno863.github.io/learn-docscss/syntax.css" />

</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/learn-docs"><span>Learn Docs</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li><a href="/learn-docs/docs/survival_analysis/"> <strong>生存時間解析</strong> </a>

<ul>
<li><a href="/learn-docs/docs/survival_analysis/kaplan-meier/">カプランマイヤー法</a></li>
<li><a href="/learn-docs/docs/survival_analysis/cumulative-hazard/"class=active>累積ハザード関数</a></li>
</ul></li>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/"> <strong>時系列分析</strong> </a>

<ul>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/state-space-model/">状態空間モデル</a></li>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/state-space-python/">状態空間モデルの実装例</a></li>
</ul></li>
</ul>






  
<ul>
  
  <li>
    <a href="https://github.com/hnakano863/learn-docs" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/learn-docs/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>累積ハザード関数</strong>

  <label for="toc-control">
    
    <img src="/learn-docs/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#累積ハザード関数の重要性">累積ハザード関数の重要性</a></li>
<li><a href="#nelson-aalen-法">Nelson-Aalen 法</a>
<ul>
<li><a href="#python-による実装">Python による実装</a></li>
</ul></li>
<li><a href="#累積ハザード関数の使い方">累積ハザード関数の使い方</a>
<ul>
<li><a href="#累積ハザード関数からハザード関数を得る">累積ハザード関数からハザード関数を得る</a></li>
<li><a href="#ハザード関数の解釈">ハザード関数の解釈</a></li>
<li><a href="#累積ハザード関数から生存関数を得る">累積ハザード関数から生存関数を得る</a></li>
</ul></li>
</ul></li>
</ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown">

<h2 id="累積ハザード関数の重要性">累積ハザード関数の重要性</h2>

<p>カプランマイヤー法は生存関数の推定を行う方法であった。</p>

<p>ここで、生存関数 \(S(t)\) と累積ハザード関数 \(H(t)\) の関係をもう一度思い出してみよう。</p>

<p>\[ \begin{align} H(t) &amp;= -\log{S(t)} \\<br />
S(t) &amp;= \exp{(-S(t))} \ \end{align} \]</p>

<p>すなわち、 \(S(t)\) と \(H(t)\) は相互に変換可能である。</p>

<p>また、これに加えて、累積ハザード関数 \(H(t)\) を微分すれば、ハザード関数 \(h(t)\) を得ることができる。</p>

<p>\[ h(t) = \frac{\mathrm{d}}{\mathrm{d}t}H(t) \]</p>

<p>ハザード関数 \(h(t)\) は時刻がちょうど \(t\) のときに寿命を迎える確率に結びついている。</p>

<p>\[ h(t) = \lim_{\delta t \to 0}\frac{\mathrm{P(t \le T \le t + \delta t|T &gt; t)}}{\delta t} \]</p>

<p>しかしながら、ハザード関数をデータから直接推定することは難しい。</p>

<p>累積ハザード関数を推定すれば、そこから生存関数やハザード関数を得ることができる。従って、生存時間解析において、累積ハザード関数を推定することは重要なステップとなる。</p>

<p>累積ハザード関数をデータから推定するためのノンパラメトリックな手法が、 <strong>Nelson-Aalen 法</strong> である。</p>

<h2 id="nelson-aalen-法">Nelson-Aalen 法</h2>

<p>以下、Nelson-Aalen 法による累積ハザード関数の推定法について説明する。説明にはカプランマイヤー法のときと同じく <a href="http://www.math.ucsd.edu/~rxu/math284/slect7.pdf">カリフォルニア大学サンディエゴ校の例示用データセット</a> を用いる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">    start  group  z  stop  id  event
0       0    1.0  0   3.0   1   True
1       0    1.0  0   5.0   2  False
2       0    1.0  1   5.0   3   True
3       0    1.0  0   6.0   4   True
4       0    1.0  0   6.0   5  False
5       6    1.0  1   8.0   5  False
6       0    0.0  1   4.0   6  False
7       0    0.0  0   5.0   7  False
8       5    0.0  1   7.0   7   True
9       0    0.0  0   8.0   8  False
10      0    0.0  0   5.0   9  False
11      5    0.0  1   9.0   9   True
12      0    0.0  0   3.0  10  False
13      3    0.0  1  10.0  10   True</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/90efd0b6b911a9c4727bd7c5049ab69971ae1221.png"/> 
</figure>


<p>まずは、カプランマイヤー法のときと同様に、生命表を作成する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">          removed  observed  censored  entrance  at_risk
event_at                                                
0.0             0         0         0        14       14
2.0             2         1         1         0       14
3.0             2         1         1         0       12
4.0             2         1         1         0       10
5.0             4         1         3         0        8
6.0             2         1         1         0        4
7.0             1         1         0         0        2
8.0             1         0         1         0        1</code></pre></div>
<p>次に、期別死亡率を計算する。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">          removed  observed  censored  entrance  at_risk  death_rate
event_at                                                            
0.0             0         0         0        14       14    0.000000
2.0             2         1         1         0       14    0.071429
3.0             2         1         1         0       12    0.083333
4.0             2         1         1         0       10    0.100000
5.0             4         1         3         0        8    0.125000
6.0             2         1         1         0        4    0.250000
7.0             1         1         0         0        2    0.500000
8.0             1         0         1         0        1    0.000000</code></pre></div>
<p>最後に、期別死亡率の累積和を求める。この累積和こそが Nelson-Aalen 法による累積ハザード関数の推定量である。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">          removed  observed  censored  entrance  at_risk  death_rate  \
event_at                                                               
0.0             0         0         0        14       14    0.000000   
2.0             2         1         1         0       14    0.071429   
3.0             2         1         1         0       12    0.083333   
4.0             2         1         1         0       10    0.100000   
5.0             4         1         3         0        8    0.125000   
6.0             2         1         1         0        4    0.250000   
7.0             1         1         0         0        2    0.500000   
8.0             1         0         1         0        1    0.000000   

          cumulative_hazard  
event_at                     
0.0                0.000000  
2.0                0.071429  
3.0                0.154762  
4.0                0.254762  
5.0                0.379762  
6.0                0.629762  
7.0                1.129762  
8.0                1.129762  </code></pre></div>
<p>推定した累積ハザード関数をグラフに表すと、以下のようになる。</p>

<figure>
    <img src="/learn-docs/ox-hugo/2aadd1e3cc9086525d1099f771e3b2e59b59b268.png"/> 
</figure>


<h3 id="python-による実装">Python による実装</h3>

<p>Python のライブラリ <code>lifelines</code> を使って、 Nelson-Aalen 法を実現する。カプランマイヤー法と同じように実装できる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> lifelines <span style="color:#f92672">import</span> NelsonAalenFitter
<span style="color:#f92672">from</span> lifelines.datasets <span style="color:#f92672">import</span> load_dfcv
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt

<span style="color:#75715e"># データを読み込んで duration 列を作成</span>
df <span style="color:#f92672">=</span> load_dfcv()<span style="color:#f92672">.</span>eval(<span style="color:#e6db74">&#39;duration = stop - start&#39;</span>)
<span style="color:#75715e"># fitter インスタンスを作成</span>
naf <span style="color:#f92672">=</span> NelsonAalenFitter()
<span style="color:#75715e"># フィット</span>
naf<span style="color:#f92672">.</span>fit(df[<span style="color:#e6db74">&#39;duration&#39;</span>], event_observed<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;event&#39;</span>])
<span style="color:#75715e"># プロット</span>
naf<span style="color:#f92672">.</span>plot(label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cumulative_hazard&#39;</span>)
<span style="color:#75715e"># 凡例の位置調整</span>
plt<span style="color:#f92672">.</span>legend(bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>), loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;upper left&#34;</span>)
<span style="color:#75715e"># グリッドを追加</span>
plt<span style="color:#f92672">.</span>grid(True, ls<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--&#34;</span>, axis<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;y&#34;</span>)
plt<span style="color:#f92672">.</span>show()</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/6b17e90843fde1d5406feade9928b4c1263ffb21.png"/> 
</figure>


<h2 id="累積ハザード関数の使い方">累積ハザード関数の使い方</h2>

<p>まず、先のセクションで推定した累積ハザード関数の縦軸の値に注目すると、その値が 1 を超えていることがわかる。すなわち、生存関数 \(S(t)\) やハザード関数 \(h(t)\) とは異なり、累積ハザード関数 \(H(t)\) は確率を与える関数 <strong>ではない</strong></p>

<p>従って、少くとも今の段階では、累積ハザード関数を見て何かを解釈することは難しい。むしろ、累積ハザード関数の価値は、そこからハザード関数 \(h(t)\) と生存関数 \(S(t)\) が得られるところにある。</p>

<h3 id="累積ハザード関数からハザード関数を得る">累積ハザード関数からハザード関数を得る</h3>

<p>上で述べたように、累積ハザード関数 \(H(t)\) を微分するとハザード関数 \(h(t)\) が得られる。</p>

<p>\[ h(t) = \frac{\mathrm{d}}{\mathrm{d}t}H(t) \]</p>

<p>この関係を利用して、Nelson-Aalen 法による推定量から、ハザード関数を推定してみよう。</p>

<p>実際には正確な微分ができるわけではないから、カーネル平滑化を行う。カーネル平滑化については本稿の主旨からずれるので解説しない。現段階では、「よしなに微分できるのだな」と思っておくとよい。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># カーネル平滑化のためには、 `bandwidth` を指定する必要がある。</span>
bandwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
<span style="color:#75715e"># 先程作成した fitter インスタンスを使い回してハザード関数をプロットする</span>
naf<span style="color:#f92672">.</span>plot_hazard(bandwidth<span style="color:#f92672">=</span>bandwidth, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;hazard_function&#39;</span>)
<span style="color:#75715e"># 凡例の位置調整</span>
plt<span style="color:#f92672">.</span>legend(bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>), loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;upper left&#34;</span>)
plt<span style="color:#f92672">.</span>show()</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/5d9b6092beab5cd64edf328399f8694b2aacc10c.png"/> 
</figure>


<p>ハザード関数 \(h(t)\) は丁度 \(t\) 年で寿命を迎える条件つき確率の、確率密度を表している。いわば、丁度 \(t\) 年のときに死ぬ危険の大きさを表しているとも言える。</p>

<p>このグラフをみると、5年目くらいから死にやすくなっていることが分かる。</p>

<h3 id="ハザード関数の解釈">ハザード関数の解釈</h3>

<p>ハザード関数の解釈に慣れるために、少し別のデータセットを用いて Nelson-Aalen 法を試してみよう。</p>

<p>今回使うデータセットは、 <code>lifelines</code> に同梱のデータセットで、各国の首相や大統領、書記長といったリーダーの在職期間を記録したものである。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> lifelines.datasets <span style="color:#f92672">import</span> load_dd

<span style="color:#75715e"># データのメタ情報</span>
<span style="color:#66d9ef">print</span>(load_dd<span style="color:#f92672">.</span>__doc__)</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">    Classification of political regimes as democracy and dictatorship.
    Classification of democracies as parliamentary, semi-presidential (mixed) and presidential.
    Classification of dictatorships as military, civilian and royal.
    Coverage: 202 countries, from 1946 or year of independence to 2008.::

        Size: (1808, 12)
        Example:
            ctryname                                                   Afghanistan
            cowcode2                                                           700
            politycode                                                         700
            un_region_name                                           Southern Asia
            un_continent_name                                                 Asia
            ehead                                              Mohammad Zahir Shah
            leaderspellreg       Mohammad Zahir Shah.Afghanistan.1946.1952.Mona...
            democracy                                                Non-democracy
            regime                                                        Monarchy
            start_year                                                        1946
            duration                                                             7
            observed                                                             1

    References
    ----------
    Cheibub, José Antonio, Jennifer Gandhi, and James Raymond Vreeland. 2010. “Democracy and Dictatorship Revisited.” Public Choice, vol. 143, no. 2-1, pp. 67-101.</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df <span style="color:#f92672">=</span> load_dd()
<span style="color:#75715e"># データシェマ</span>
<span style="color:#66d9ef">print</span>(df<span style="color:#f92672">.</span>info())
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">80</span>)
<span style="color:#75715e"># 頭 5 行</span>
<span style="color:#66d9ef">print</span>(df<span style="color:#f92672">.</span>head())
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">80</span>)
<span style="color:#75715e"># `democracy` 列の値を確認</span>
<span style="color:#66d9ef">print</span>(df[<span style="color:#e6db74">&#39;democracy&#39;</span>]<span style="color:#f92672">.</span>unique())</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 1808 entries, 0 to 1807
Data columns (total 12 columns):
 #   Column             Non-Null Count  Dtype  
---  ------             --------------  -----  
 0   ctryname           1808 non-null   object 
 1   cowcode2           1808 non-null   int64  
 2   politycode         1801 non-null   float64
 3   un_region_name     1808 non-null   object 
 4   un_continent_name  1808 non-null   object 
 5   ehead              1808 non-null   object 
 6   leaderspellreg     1808 non-null   object 
 7   democracy          1808 non-null   object 
 8   regime             1808 non-null   object 
 9   start_year         1808 non-null   int64  
 10  duration           1808 non-null   int64  
 11  observed           1808 non-null   int64  
dtypes: float64(1), int64(4), object(7)
memory usage: 169.6+ KB
None
================================================================================
      ctryname  cowcode2  politycode un_region_name un_continent_name  \
0  Afghanistan       700       700.0  Southern Asia              Asia   
1  Afghanistan       700       700.0  Southern Asia              Asia   
2  Afghanistan       700       700.0  Southern Asia              Asia   
3  Afghanistan       700       700.0  Southern Asia              Asia   
4  Afghanistan       700       700.0  Southern Asia              Asia   

                   ehead                                     leaderspellreg  \
0    Mohammad Zahir Shah  Mohammad Zahir Shah.Afghanistan.1946.1952.Mona...   
1  Sardar Mohammad Daoud  Sardar Mohammad Daoud.Afghanistan.1953.1962.Ci...   
2    Mohammad Zahir Shah  Mohammad Zahir Shah.Afghanistan.1963.1972.Mona...   
3  Sardar Mohammad Daoud  Sardar Mohammad Daoud.Afghanistan.1973.1977.Ci...   
4    Nur Mohammad Taraki  Nur Mohammad Taraki.Afghanistan.1978.1978.Civi...   

       democracy         regime  start_year  duration  observed  
0  Non-democracy       Monarchy        1946         7         1  
1  Non-democracy  Civilian Dict        1953        10         1  
2  Non-democracy       Monarchy        1963        10         1  
3  Non-democracy  Civilian Dict        1973         5         0  
4  Non-democracy  Civilian Dict        1978         1         0  
================================================================================
[&#39;Non-democracy&#39; &#39;Democracy&#39;]</code></pre></div>
<p>いくつか必要な列を説明する。<br />
まず、 <code>duration</code> は在職年数を表す。次に、 <code>observed</code> が調査期間中に退任したか否かを表す。在職中に死亡した場合や調査終了時に在職だった場合は右打切りと考えるので、 <code>observed</code> は 0 となる。 <code>democracy</code> はカテゴリカルな値で、民主的な政体か、独裁主義などの非民主的な政体かを表している。</p>

<p>今回は、 <code>democracy</code> 列の値を利用してデータを 2 分割することにより、政体ごとのハザード関数の差を見てみよう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># `democracy`列を使ってデータを 2 分割する</span>
df_democrat <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;democracy == &#34;Democracy&#34;&#39;</span>)
df_non_democrat <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;democracy == &#34;Non-democracy&#34;&#39;</span>)

<span style="color:#75715e"># ハザード関数用のパラメタ</span>
bandwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()

<span style="color:#75715e"># 民主主義</span>
naf_democrat <span style="color:#f92672">=</span> NelsonAalenFitter()
naf_democrat<span style="color:#f92672">.</span>fit(df_democrat[<span style="color:#e6db74">&#39;duration&#39;</span>], event_observed<span style="color:#f92672">=</span>df_democrat[<span style="color:#e6db74">&#39;observed&#39;</span>])
naf_democrat<span style="color:#f92672">.</span>plot_hazard(bandwidth<span style="color:#f92672">=</span>bandwidth, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Democracy&#34;</span>, loc<span style="color:#f92672">=</span>slice(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">22</span>))
<span style="color:#75715e"># 非民主主義</span>
naf_non_democrat <span style="color:#f92672">=</span> NelsonAalenFitter()
naf_non_democrat<span style="color:#f92672">.</span>fit(df_non_democrat[<span style="color:#e6db74">&#39;duration&#39;</span>], event_observed<span style="color:#f92672">=</span>df_non_democrat[<span style="color:#e6db74">&#39;observed&#39;</span>])
naf_non_democrat<span style="color:#f92672">.</span>plot_hazard(bandwidth<span style="color:#f92672">=</span>bandwidth, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Non-democracy&#34;</span>, loc<span style="color:#f92672">=</span>slice(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">44</span>))

plt<span style="color:#f92672">.</span>show()</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/f5c19d6a80f2c912d681d1a8f7c1fbef9b6c4865.png"/> 
</figure>


<p>グラフを見れば、基本的に民主政権のほうが非民主政権よりもハザード関数の値が大きいことがわかる。すなわち、民主政権のほうがリーダーの交代が起こりやすいことを示している。</p>

<p>また、民主政権のほうには在位 5 年目ほどと 12 年目ほどに 2 つ山があるのが見られる。おそらく民主政権での任期満了時期がこのあたりになるのだろう。これらの山は選挙に際して政権交代が起こりやすいことを示しているかもしれない。逆に、非民主政権は、最初の 4 年ほどは若干政権交代がおこりやすいが、そこをこえれば安定した長期政権になることが、ハザード関数の値の推移から推測できる。</p>

<p>以上のように、ハザード関数はある時期のイベントの起りやすさ(=死にやすさ)を評価していると解釈してよい。</p>

<p>例えば、工業製品のハザード関数などは、初期不良により最初は高く、その後初期不良のない製品ばかりになるので低下し、そして寿命を迎えるころには再度高いハザード関数の値になる。</p>

<figure>
    <img src="/learn-docs/ox-hugo/bathtab.png"/> 
</figure>


<p>このような曲線をバスタブ曲線という</p>

<h3 id="累積ハザード関数から生存関数を得る">累積ハザード関数から生存関数を得る</h3>

<p>累積ハザード関数 \(H(t)\) と生存関数 \(S(t)\) の間には、</p>

<p>\[ S(t) =  \exp (-H(t)) \]</p>

<p>という関係が成り立つ。従って、累積ハザード関数から生存関数を計算することができる。</p>

<p>Nelson-Aalen 法によって推定した累積ハザード関数から、この関係式を使って生存関数を推定する方法を、 <strong>Fleming-Harrington 法</strong> という。</p>

<p><code>lifelines</code> では、 <code>BreslowFlemingHarringtonFitter</code> というクラスが、Fleming-Harrington 法を実装している。</p>

<p>再び、カリフォルニア大学サンディエゴ校の例示用データセットを用いて、カプランマイヤー法と比較してみよう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> lifelines <span style="color:#f92672">import</span> KaplanMeierFitter, BreslowFlemingHarringtonFitter
<span style="color:#f92672">from</span> matplotlib.ticker <span style="color:#f92672">import</span> PercentFormatter

<span style="color:#75715e"># データをロードして`duration`列を作成</span>
df <span style="color:#f92672">=</span> load_dfcv()<span style="color:#f92672">.</span>eval(<span style="color:#e6db74">&#39;duration = stop - start&#39;</span>)

<span style="color:#75715e"># 1 行 2 列でサブプロットを作成</span>
fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, sharex<span style="color:#f92672">=</span>True, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">4.8</span>))
<span style="color:#75715e"># カラーマップを準備</span>
cmap <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>get_cmap(<span style="color:#e6db74">&#39;tab10&#39;</span>)

<span style="color:#75715e"># カプランマイヤー法と Fleming-Harrington 法のプロットを作成</span>
<span style="color:#66d9ef">for</span> i, fitter <span style="color:#f92672">in</span> enumerate([KaplanMeierFitter(), BreslowFlemingHarringtonFitter()]):
    fitter<span style="color:#f92672">.</span>fit(df[<span style="color:#e6db74">&#39;duration&#39;</span>], event_observed<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;event&#39;</span>])
    <span style="color:#75715e"># これは`BreslowFlemingHarringtonFitter.plot()`のバグに対するパッチ</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> hasattr(fitter, <span style="color:#e6db74">&#34;confidence_interval_survival_function_&#34;</span>):
        fitter<span style="color:#f92672">.</span>confidence_interval_survival_function_ <span style="color:#f92672">=</span> fitter<span style="color:#f92672">.</span>confidence_interval_
    fitter<span style="color:#f92672">.</span>plot(ax<span style="color:#f92672">=</span>ax[i], color<span style="color:#f92672">=</span>cmap(i))
    <span style="color:#75715e"># プロットの体裁を整える</span>
    ax[i]<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_formatter(PercentFormatter(xmax<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
    ax[i]<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>grid(True, ls<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--&#34;</span>)
    ax[i]<span style="color:#f92672">.</span>set_title(f<span style="color:#e6db74">&#34;{fitter.__class__.__name__} Estimate&#34;</span>)

plt<span style="color:#f92672">.</span>show()</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/19f97f0a6226bd1cd4a5ee01451ba0d90f8b502a.png"/> 
</figure>


<p>左右の違いを比べると殆ど変らないことがわかる。では、わざわざ Fleming-Harrington 法を使う理由はどこにあるのだろうか。</p>

<p>実は、サンプルが少ない場合、Fleming-Harrington 法のほうが極端な値が出にくくなるというメリットがある。これは、カプランマイヤー法が累積積を用いるので異常な値の影響を受けやすいのに対し、Fleming-Harrington 法は累積和を用いるため異常値の影響を抑えられるからである。</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#累積ハザード関数の重要性">累積ハザード関数の重要性</a></li>
<li><a href="#nelson-aalen-法">Nelson-Aalen 法</a>
<ul>
<li><a href="#python-による実装">Python による実装</a></li>
</ul></li>
<li><a href="#累積ハザード関数の使い方">累積ハザード関数の使い方</a>
<ul>
<li><a href="#累積ハザード関数からハザード関数を得る">累積ハザード関数からハザード関数を得る</a></li>
<li><a href="#ハザード関数の解釈">ハザード関数の解釈</a></li>
<li><a href="#累積ハザード関数から生存関数を得る">累積ハザード関数から生存関数を得る</a></li>
</ul></li>
</ul></li>
</ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












