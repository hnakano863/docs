<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="カプランマイヤー法 カプランマイヤー法は、生存関数を実データから推測するためのノンパラメトリックな手法のひとつ。生存時間解析では最も基本的な手法である。
本稿では、カプランマイヤー法の説明のために、以下のデータセットを用いる。
start group z stop id event 0 0 1.0 0 3.0 1 True 1 0 1.0 0 5.0 2 False 2 0 1.0 1 5.0 3 True 3 0 1.0 0 6.0 4 True 4 0 1.0 0 6.0 5 False 5 6 1.0 1 8.0 5 False 6 0 0.0 1 4.0 6 False 7 0 0.0 0 5.0 7 False 8 5 0.0 1 7.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Kaplan-Meier Method" />
<meta property="og:description" content="カプランマイヤー法 カプランマイヤー法は、生存関数を実データから推測するためのノンパラメトリックな手法のひとつ。生存時間解析では最も基本的な手法である。
本稿では、カプランマイヤー法の説明のために、以下のデータセットを用いる。
start group z stop id event 0 0 1.0 0 3.0 1 True 1 0 1.0 0 5.0 2 False 2 0 1.0 1 5.0 3 True 3 0 1.0 0 6.0 4 True 4 0 1.0 0 6.0 5 False 5 6 1.0 1 8.0 5 False 6 0 0.0 1 4.0 6 False 7 0 0.0 0 5.0 7 False 8 5 0.0 1 7." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hanakno863.github.io/learn-docs/docs/survival_analysis/kaplan-meier/" />
<meta property="article:modified_time" content="2020-06-04T16:23:30+09:00" />
<title>Kaplan-Meier Method | Learn Docs</title>
<link rel="manifest" href="/learn-docs/manifest.json">
<link rel="icon" href="/learn-docs/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/learn-docs/book.min.e161f1fe2b283b6a43c29a52fde96e2387fade573e78efa6701d44c8499da76b.css" integrity="sha256-4WHx/isoO2pDwppS/eluI4f63lc&#43;eO&#43;mcB1EyEmdp2s=">
<script defer src="/learn-docs/en.search.min.925e38f9e5deb3a6396aa95a04de4cd37c3ccc0dca82e0a99c666266537207a1.js" integrity="sha256-kl44&#43;eXes6Y5aqlaBN5M03w8zA3KguCpnGZiZlNyB6E="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"],
    }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
      TeX: {
          Macros: { bm: ["\\boldsymbol{#1}", 1] }
      }
  });
</script>

<link rel="stylesheet" href="http://hanakno863.github.io/learn-docscss/syntax.css" />

</head>

<body dir=>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/learn-docs"><span>Learn Docs</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li><a href="/learn-docs/docs/survival_analysis/"> <strong>生存時間解析</strong> </a>

<ul>
<li><a href="/learn-docs/docs/survival_analysis/kaplan-meier/"class=active>カプランマイヤー法</a></li>
<li><a href="/learn-docs/docs/survival_analysis/cumulative-hazard/">累積ハザード関数</a></li>
</ul></li>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/"> <strong>時系列分析</strong> </a>

<ul>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/preprocessing/">時系列データの前処理</a></li>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/state-space-model/">状態空間モデル</a></li>
<li><a href="/learn-docs/docs/%E6%99%82%E7%B3%BB%E5%88%97%E5%88%86%E6%9E%90/state-space-python/">状態空間モデルの実装例</a></li>
</ul></li>
</ul>






  
<ul>
  
  <li>
    <a href="https://github.com/hnakano863/learn-docs" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/learn-docs/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Kaplan-Meier Method</strong>

  <label for="toc-control">
    
    <img src="/learn-docs/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#カプランマイヤー法">カプランマイヤー法</a>
<ul>
<li><a href="#観測データの前処理">観測データの前処理</a></li>
<li><a href="#生命表">生命表</a></li>
<li><a href="#期別生存率">期別生存率</a></li>
<li><a href="#累積生存率">累積生存率</a></li>
</ul></li>
<li><a href="#python-での実装">Python での実装</a></li>
</ul></li>
</ul>
</nav>


    </aside>
  
 
      </header>

      
      
  <article class="markdown">

<h2 id="カプランマイヤー法">カプランマイヤー法</h2>

<p>カプランマイヤー法は、生存関数を実データから推測するためのノンパラメトリックな手法のひとつ。生存時間解析では最も基本的な手法である。</p>

<p>本稿では、カプランマイヤー法の説明のために、以下のデータセットを用いる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">    start  group  z  stop  id  event
0       0    1.0  0   3.0   1   True
1       0    1.0  0   5.0   2  False
2       0    1.0  1   5.0   3   True
3       0    1.0  0   6.0   4   True
4       0    1.0  0   6.0   5  False
5       6    1.0  1   8.0   5  False
6       0    0.0  1   4.0   6  False
7       0    0.0  0   5.0   7  False
8       5    0.0  1   7.0   7   True
9       0    0.0  0   8.0   8  False
10      0    0.0  0   5.0   9  False
11      5    0.0  1   9.0   9   True
12      0    0.0  0   3.0  10  False
13      3    0.0  1  10.0  10   True</code></pre></div>
<p>このデータセットは、カリフォルニア サンディエゴ大学の数学科が公開している講義資料の中に出て来た例示用のデータセットである。<br />
<a href="http://www.math.ucsd.edu/~rxu/math284/slect7.pdf">http://www.math.ucsd.edu/~rxu/math284/slect7.pdf</a> から、もとのデータセットを見ることができる。</p>

<p><code>event</code> 列が死亡の有無、 <code>start</code> は観察開始時期、 <code>stop</code> は観察終了時期を表している。他の列については本稿では用いない。</p>

<p>それぞれのサンプルの観察期間と、死亡の有無を確認すると、</p>

<figure>
    <img src="/learn-docs/ox-hugo/359e8499d0ce81af783a94fb361ad4c89e8faf50.png"/> 
</figure>


<p>半分程度が打切りであり、観測期間もサンプルによってまちまちであることがわかる。</p>

<h3 id="観測データの前処理">観測データの前処理</h3>

<p>カプランマイヤー法の適用のために、まずは観測データを前処理する。</p>

<p>まずは、サンプルの観察開始点をそろえる。</p>

<figure>
    <img src="/learn-docs/ox-hugo/5361b5ff0a07c9c27cea1d9d695a0a207ae73324.png"/> 
</figure>


<p>次に、これを生存時間順に並べ替える</p>

<figure>
    <img src="/learn-docs/ox-hugo/1bfafb38790e5b3e4d57474eff3d34a1ff78e3e1.png"/> 
</figure>


<h3 id="生命表">生命表</h3>

<p>上のグラフをみると、観察期間が 2 年までは全 14 サンプルのデータが存在しているが、その後 3 年、4年と観察期間が伸びていくほどに、サンプル数が減っていくことがわかる。</p>

<p>そこで、観察期間とサンプル数、死亡数の推移をまとめた表を作成する。この表を <strong>生命表</strong> という。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">          removed  observed  censored  entrance  at_risk
event_at                                                
0.0             0         0         0        14       14
2.0             2         1         1         0       14
3.0             2         1         1         0       12
4.0             2         1         1         0       10
5.0             4         1         3         0        8
6.0             2         1         1         0        4
7.0             1         1         0         0        2
8.0             1         0         1         0        1</code></pre></div>
<p>生命表のインデックスは観察期間を示す。これはグラフの x 軸に対応する。<br />
<code>at_risk</code> 列が期間中のサンプルの数、 <code>observed</code> は死亡数、 <code>censored</code> が右打切りの数である。</p>

<p>例えば、2年目まではサンプルは 14 個体、そのうち、右打切りが 1 個体、死亡が 1 個体である。</p>

<h3 id="期別生存率">期別生存率</h3>

<p>サンプル \(n\) 個体中、 \(m\) 個体が死んだ場合、死亡率は \(\frac{m}{n}\) で計算できる。生存率は、死亡率を 1 から引けば求められるので、 \(1 - \frac{m}{n}\) である。</p>

<p>ここで、生命表を見ればわかるように、サンプルの数は観察期間によって異なる。そこで、観察期間ごとに生存率を算出する。この生存率を、期別生存率という。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">          removed  observed  censored  entrance  at_risk  death_rate  \
event_at                                                               
0.0             0         0         0        14       14    0.000000   
2.0             2         1         1         0       14    0.071429   
3.0             2         1         1         0       12    0.083333   
4.0             2         1         1         0       10    0.100000   
5.0             4         1         3         0        8    0.125000   
6.0             2         1         1         0        4    0.250000   
7.0             1         1         0         0        2    0.500000   
8.0             1         0         1         0        1    0.000000   

          survival_rate  
event_at                 
0.0            1.000000  
2.0            0.928571  
3.0            0.916667  
4.0            0.900000  
5.0            0.875000  
6.0            0.750000  
7.0            0.500000  
8.0            1.000000  </code></pre></div>
<h3 id="累積生存率">累積生存率</h3>

<p>期別生存率を互いに掛け合せたもの(累積積)を <strong>累積生存率</strong> という。</p>

<p>カプランマイヤー法とは、この累積生存率を生存関数の推定値とする統計手法である。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">          removed  observed  censored  entrance  at_risk  death_rate  \
event_at                                                               
0.0             0         0         0        14       14    0.000000   
2.0             2         1         1         0       14    0.071429   
3.0             2         1         1         0       12    0.083333   
4.0             2         1         1         0       10    0.100000   
5.0             4         1         3         0        8    0.125000   
6.0             2         1         1         0        4    0.250000   
7.0             1         1         0         0        2    0.500000   
8.0             1         0         1         0        1    0.000000   

          survival_rate  cumulative_survival_rate  
event_at                                           
0.0            1.000000                  1.000000  
2.0            0.928571                  0.928571  
3.0            0.916667                  0.851190  
4.0            0.900000                  0.766071  
5.0            0.875000                  0.670312  
6.0            0.750000                  0.502734  
7.0            0.500000                  0.251367  
8.0            1.000000                  0.251367  </code></pre></div>
<p>この累積生存率をグラフにすると以下のようになる。</p>

<figure>
    <img src="/learn-docs/ox-hugo/7787d4ef99c5d23a4013bcadf328747eb215168a.png"/> 
</figure>


<h2 id="python-での実装">Python での実装</h2>

<p>Python の生存時間解析用ライブラリである <code>lifelines</code> を使えば、カプランマイヤー法がすぐに使える。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">from</span> lifelines <span style="color:#f92672">import</span> KaplanMeierFitter
<span style="color:#f92672">from</span> lifelines.datasets <span style="color:#f92672">import</span> load_dfcv
<span style="color:#f92672">from</span> lifelines.plotting <span style="color:#f92672">import</span> plot_lifetimes

<span style="color:#75715e"># データセットのダウンロード</span>
<span style="color:#75715e"># 前の章までのデータと同じものを使っている。</span>
dfcv_data <span style="color:#f92672">=</span> load_dfcv()
<span style="color:#75715e"># 観察期間の長さを計算</span>
dfcv_data[<span style="color:#e6db74">&#39;duration&#39;</span>] <span style="color:#f92672">=</span> dfcv_data[<span style="color:#e6db74">&#39;stop&#39;</span>] <span style="color:#f92672">-</span> dfcv_data[<span style="color:#e6db74">&#39;start&#39;</span>]

<span style="color:#75715e"># インスタンス化</span>
kmf <span style="color:#f92672">=</span> KaplanMeierFitter()

<span style="color:#75715e"># データに Fit</span>
kmf<span style="color:#f92672">.</span>fit(
    dfcv_data[<span style="color:#e6db74">&#39;duration&#39;</span>],
    event_observed<span style="color:#f92672">=</span>dfcv_data[<span style="color:#e6db74">&#39;event&#39;</span>]
)

<span style="color:#75715e"># プロット</span>
kmf<span style="color:#f92672">.</span>plot()
plt<span style="color:#f92672">.</span>show()</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/5dd6dcccd713ad0518943a71e1f15634df915a83.png"/> 
</figure>


<p>薄色は 95%信頼区間であり、 <code>plot()</code> のキーワード引数 <code>ci_show</code> に <code>False</code> を渡すことで表示を無くせる。また、系列名はデフォルトで <code>KM_estimate</code> となるが、これも同じくキーワード引数 <code>label</code> に渡す値で変えられる。他にも、 <code>lifelines.plotting.add_at_risk_counts</code> を使えば、サンプル数の変化を表示させることができる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> lifelines.plotting <span style="color:#f92672">import</span> add_at_risk_counts
<span style="color:#f92672">from</span> matplotlib.ticker <span style="color:#f92672">import</span> PercentFormatter

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()

kmf<span style="color:#f92672">.</span>plot(
    ax<span style="color:#f92672">=</span>ax,  <span style="color:#75715e"># 既に存在する subplot にプロットする</span>
    ci_show<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># 信頼区間を非表示</span>
    label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Fantastic Result&#34;</span>,  <span style="color:#75715e"># 系列名の変更</span>
    iloc<span style="color:#f92672">=</span>slice(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">7</span>),  <span style="color:#75715e"># プロットする範囲を 0~7 年に制限</span>
    linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--&#34;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>,  <span style="color:#75715e"># matplotlib の plot と同じキーワード引数が使える。</span>
)


<span style="color:#75715e"># サンプル数の変化を表示</span>
add_at_risk_counts(kmf, ax<span style="color:#f92672">=</span>ax, labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;Fantastic Result&#34;</span>])

<span style="color:#75715e"># 普通の matplotlib のオブジェクトとして操作できる。</span>
ax<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_formatter(PercentFormatter(xmax<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>))
ax<span style="color:#f92672">.</span>set_ylim(<span style="color:#ae81ff">0</span>, None)

plt<span style="color:#f92672">.</span>show()</code></pre></div>
<figure>
    <img src="/learn-docs/ox-hugo/7c141419641be6771f4245076d5925e454a67e6f.png"/> 
</figure>

</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#カプランマイヤー法">カプランマイヤー法</a>
<ul>
<li><a href="#観測データの前処理">観測データの前処理</a></li>
<li><a href="#生命表">生命表</a></li>
<li><a href="#期別生存率">期別生存率</a></li>
<li><a href="#累積生存率">累積生存率</a></li>
</ul></li>
<li><a href="#python-での実装">Python での実装</a></li>
</ul></li>
</ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












